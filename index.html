<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Manager v18 - Best & Prova Top Ranking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --background-dark: #121417; --container-bg: #22252A; --header-bg: #2D2F3E;
            --element-bg: #3A3D4D; --element-bg-hover: #4a4e5a; --primary-accent: #007BFF;
            --primary-accent-dark: #0056b3; --text-primary: #FFFFFF; --text-secondary: #E0E0E0;
            --text-muted: #9E9E9E; --border-color: #3A3D4D; --star-yellow: #FFC107;
            --btn-green: #28a745; --btn-red: #dc3545; --variable-text: #FF9800;
            --btn-pink: #e84393; --btn-gold: #f39c12;
        }
        [data-theme="light"] {
            --background-dark: #F5F5F5; --container-bg: #FFFFFF; --header-bg: #E3E6F0;
            --element-bg: #F8F9FA; --element-bg-hover: #E9ECEF; --primary-accent: #0066CC;
            --text-primary: #212529; --text-secondary: #495057; --border-color: #DEE2E6;
            --star-yellow: #FFC107; --variable-text: #E65100;
        }
        * { box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--background-dark); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; color: var(--text-primary); display: flex; flex-direction: column; }
        .app-header { background-color: var(--header-bg); border-radius: 16px; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,.2); margin-bottom: 20px; flex-shrink: 0; }
        .header-left, .header-center, .header-right { display: flex; align-items: center; gap: 16px; }
        .logo { color: var(--text-primary); font-size: 28px; font-weight: bold; }
        .search-bar { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        .search-bar input { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 10px; font-size: 16px; width: 280px; }
        .search-bar i { cursor: pointer; color: var(--text-muted); }
        .search-bar i:hover { color: var(--text-primary); }
        .category-dropdown-container { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        #category-dropdown { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 0; font-size: 16px; width: 220px; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; }
        #category-dropdown option { background-color: var(--container-bg); color: var(--text-primary); }
        .tool-button { background-color: #7A69E9; color: #FFFFFF; border: none; border-radius: 12px; padding: 10px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .theme-toggle { background-color: var(--element-bg); color: var(--text-primary); border: none; border-radius: 12px; padding: 10px 16px; font-size: 18px; cursor: pointer; }
        .header-right { position: relative; }
        .toolbar-dropdown-menu { display: none; position: absolute; top: 110%; right: 0; background-color: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; z-index: 1000; width: 360px; box-shadow: 0 8px 16px rgba(0,0,0,.4); grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .toolbar-dropdown-menu.show { display: grid; }
        .toolbar-btn { color: white; border: none; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; text-align: center; min-height: 70px; }
        .toolbar-btn:disabled { background-color: #555 !important; cursor: not-allowed; opacity: .5; }
        .btn-green { background-color: var(--btn-green); } .btn-yellow { background-color: #f7b731; color: #333; } .btn-blue { background-color: #007bff; } .btn-dark-blue { background-color: #0d47a1; } .btn-red { background-color: var(--btn-red); }
        
        main { display: grid; gap: 20px; flex-grow: 1; min-height: 0; }
        main.view-mode-three-column { grid-template-columns: 320px 320px 1fr; }
        main.view-mode-two-column { grid-template-columns: 400px 1fr; }

        .column { background-color: var(--container-bg); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--element-bg); padding-bottom: 10px; flex-shrink: 0; }
        .column-header-title { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .column-header h3 { margin: 0; font-size: 18px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .column-header-title .rename-icon { color: var(--text-muted); cursor: pointer; font-size: 15px; }
        .column-header-title .rename-icon:hover { color: var(--primary-accent); }
        .column-header-title .delete-icon { color: var(--text-muted); cursor: pointer; font-size: 15px; margin-left: 8px; }
        .column-header-title .delete-icon:hover { color: var(--btn-red); }
        
        .column-content { overflow-y: auto; padding-right: 10px; margin-right: -10px; flex-grow: 1; min-height: 0; }
        .column-content::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-thumb { background-color: var(--element-bg); border-radius: 20px; }
        
        .add-button { background-color: var(--btn-green); color: white; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
        .item-container { display: flex; flex-direction: column; align-items: flex-start; padding: 12px; background-color: var(--element-bg); border-radius: 6px; margin-bottom: 8px; color: var(--text-secondary); border-left: 3px solid transparent; cursor: pointer; }
        .item-container:hover { background-color: var(--element-bg-hover); }
        .item-container.active { background-color: var(--primary-accent-dark); border-left-color: var(--star-yellow); color: white; }
        .item-name { font-weight: 500; margin-bottom: 4px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-path { font-size: 12px; color: var(--text-muted); }
        .item-container.active .item-path { color: #ddd; }
        
        .tag-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 600; 
            margin: 2px 4px 2px 0; 
            color: white;
            white-space: nowrap;
        }
        .tags-container { 
            display: flex; 
            flex-wrap: wrap; 
            margin-top: 6px; 
            gap: 4px;
        }
        .tag-input-section {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--element-bg);
        }
        .tag-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .tag-input-wrapper input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--container-bg);
            color: var(--text-primary);
            font-size: 14px;
        }
        .tag-input-wrapper button {
            padding: 8px 16px;
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .tag-input-wrapper button:hover {
            background-color: var(--primary-accent-dark);
        }
        .current-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .tag-badge-removable {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }
        .tag-badge-removable i {
            font-size: 10px;
            opacity: 0.8;
        }
        .tag-badge-removable:hover {
            opacity: 0.8;
        }
        
        /* VARIABLES SECTION STYLES */
        .variables-container {
            padding: 15px 20px;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        .variables-container.active {
            display: flex;
        }
        .variables-header {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--variable-text);
            font-weight: bold;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .variable-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .variable-label {
            min-width: 100px;
            max-width: 150px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .variable-input, .variable-select {
            flex: 1;
            padding: 10px;
            background-color: var(--element-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .variable-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239E9E9E%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
        }
        .variable-input:focus, .variable-select:focus {
            border-color: var(--primary-accent);
            outline: none;
        }

        #col-detail, #col-special-detail { padding: 0; }
        .prompt-detail-view { height: 100%; display: flex; flex-direction: column; }
        .prompt-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0;}
        .prompt-actions-toolbar { display: flex; gap: 15px; }
        .prompt-actions-toolbar i { cursor: pointer; font-size: 18px; }
        .prompt-actions-toolbar .fa-star.fa-solid { color: var(--star-yellow); }
        .prompt-actions-toolbar .fa-vial { color: var(--btn-pink); }
        .prompt-actions-toolbar .fa-trophy { color: var(--btn-gold); }
        .prompt-title-section { display: flex; align-items: center; gap: 15px; padding: 15px 20px; }
        .prompt-title-section h1 { margin: 0; font-size: 24px; color: var(--text-primary); }
        .prompt-title-section .rename-icon { color: var(--text-muted); cursor: pointer; font-size: 20px; }
        .prompt-title-section .rename-icon:hover { color: var(--primary-accent); }

        #formatting-toolbar { padding: 10px 20px; display: none; gap: 8px; align-items: center; flex-wrap: wrap; background-color: var(--element-bg); border-bottom: 1px solid var(--border-color); }
        #formatting-toolbar.show { display: flex; }
        #formatting-toolbar button { 
            background: var(--element-bg-hover); 
            border: none; 
            color: var(--text-primary); 
            padding: 8px 12px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #formatting-toolbar button:hover { background: var(--primary-accent-dark); }
        #btnSaveChanges { background-color: var(--primary-accent); display: none; margin-left: auto; color: #FFFFFF; }
        #btnSaveChanges.show { display: inline-block; }
        .prompt-description-container { padding: 20px; line-height: 1.7; flex-grow: 1; overflow-y: auto; min-height: 0; }
        .prompt-description-container:focus { outline: none; }
        .prompt-description-container[contenteditable="true"] { outline: 2px dashed var(--primary-accent); }
        .initial-message { text-align: center; color: var(--text-muted); font-size: 16px; padding: 20px; height: 100%; display: flex; align-items: center; justify-content: center; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--container-bg); border-left: 4px solid var(--primary-accent); padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.3); }
        .toast.error { border-left-color: var(--btn-red); } .toast.success { border-left-color: var(--btn-green); }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .loading-spinner i { font-size: 48px; color: var(--primary-accent); animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .prompt-description-container[contenteditable="true"].drag-over {
            outline: 3px dashed var(--star-yellow);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .prompt-description-container a {
            color: #FFA500;
            text-decoration: underline;
            cursor: pointer;
        }
        .prompt-description-container a:hover {
            color: #FF8C00;
            text-decoration: underline;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center; align-items: center;
            z-index: 10001;
        }

        .modal-content {
            background-color: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-content h4 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.25rem;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0 25px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--element-bg);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }
        
        .modal-content input[type="text"]:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn.cancel {
            background-color: var(--element-bg-hover);
            color: var(--text-secondary);
        }

        .modal-btn.confirm {
            background-color: var(--primary-accent);
            color: white;
        }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay"><div class="loading-spinner"><i class="fa-solid fa-spinner"></i></div></div>

<div class="modal-overlay" id="linkModal">
    <div class="modal-content">
        <h4>Inserisci l'URL del Link</h4>
        <input type="text" id="linkUrlInput" placeholder="Es: https://www.google.it" value="">
        <div class="modal-actions">
            <button class="modal-btn cancel" id="linkModalCancel">Annulla</button>
            <button class="modal-btn confirm" id="linkModalConfirm">Conferma</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="renameModal">
    <div class="modal-content">
        <h4 id="renameModalTitle">Rinomina Elemento</h4>
        <input type="text" id="renameInput" placeholder="Inserisci il nuovo nome...">
        <div class="modal-actions">
            <button class="modal-btn cancel" id="renameModalCancel">Annulla</button>
            <button class="modal-btn confirm" id="renameModalConfirm">Conferma</button>
        </div>
    </div>
</div>


<header class="app-header">
    <div class="header-left"><div class="logo">PS</div></div>
    <div class="header-center">
        <div class="search-bar">
             <i class="fa-solid fa-magnifying-glass" id="search-icon"></i>
             <input type="text" id="search-input" placeholder="Cerca...">
        </div>
        <div class="category-dropdown-container">
            <i class="fa-solid fa-list"></i>
            <select id="category-dropdown" title="Seleziona una categoria"></select>
        </div>
    </div>
    <div class="header-right">
        <button class="theme-toggle" id="themeToggle" title="Cambia tema"><i class="fa-solid fa-moon"></i></button>
        <button class="tool-button" id="toolBtn"><i class="fa-solid fa-screwdriver-wrench"></i><span>Tool</span></button>
        <div class="toolbar-dropdown-menu" id="toolMenu">
            <button class="toolbar-btn btn-green" id="btnAddCategory"><i class="fa-solid fa-plus"></i><span>Aggiungi Categoria</span></button>
            <button class="toolbar-btn btn-yellow" id="btnAnnulla"><i class="fa-solid fa-arrow-rotate-left"></i><span>Annulla</span></button>
            <button class="toolbar-btn btn-yellow" id="btnRipristina"><i class="fa-solid fa-arrow-rotate-right"></i><span>Ripristina</span></button>
            <button class="toolbar-btn btn-blue" id="btnBackup"><i class="fa-solid fa-download"></i><span>Backup</span></button>
            <button class="toolbar-btn btn-dark-blue" id="btnImporta"><i class="fa-solid fa-upload"></i><span>Importa</span></button>
        </div>
    </div>
</header>
<input type="file" id="backupInput" style="display:none" accept=".json">
<input type="file" id="imageInput" style="display:none" accept="image/*">

<main id="main-content-area"></main>

<script>
(async () => {
    // --- SYSTEMS ---
    const Loader = { el: document.getElementById('loading-overlay'), show() { this.el.style.display = 'flex'; }, hide() { this.el.style.display = 'none'; } };
    const Toast = { container: document.getElementById('toast-container'), show(message, type = 'info', duration = 3000) { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; this.container.appendChild(t); setTimeout(() => t.remove(), duration); } };
    
    // MOTORE DATABASE MIGLIORATO
    const Database = { 
        DB_NAME: "PromptManagerDB_v15_Tags", 
        STORE_NAME: "promptsData", 
        db: null, 
        async init() { 
            return new Promise((resolve, reject) => { 
                const r = indexedDB.open(this.DB_NAME, 1); 
                r.onerror = reject; 
                r.onsuccess = e => { this.db = e.target.result; resolve(); }; 
                r.onupgradeneeded = e => e.target.result.createObjectStore(this.STORE_NAME, {keyPath:"id"}); 
            }); 
        }, 
        async save(data) { 
            return new Promise((resolve, reject) => { 
                if (!this.db) return reject("DB non inizializzato");
                const tx = this.db.transaction([this.STORE_NAME], "readwrite"); 
                // Clonazione profonda per evitare problemi di riferimenti IndexedDB
                const cleanData = JSON.parse(JSON.stringify(data));
                tx.objectStore(this.STORE_NAME).put({id: "main", data: cleanData}); 
                tx.oncomplete = () => resolve(); 
                tx.onerror = e => reject(e); 
            }); 
        }, 
        async load() { 
            return new Promise((resolve, reject) => { 
                if (!this.db) return reject("DB non inizializzato");
                const r = this.db.transaction([this.STORE_NAME]).objectStore(this.STORE_NAME).get("main"); 
                r.onsuccess = e => resolve(e.target.result ? e.target.result.data : []); 
                r.onerror = reject; 
            }); 
        } 
    };
    
    // UTILITY: Genera colore per tag
    function getTagColor(tagName) {
        let hash = 0;
        for (let i = 0; i < tagName.length; i++) {
            hash = tagName.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = hash % 360;
        return `hsl(${hue}, 65%, 50%)`;
    }

    // UTILITY: Escape regex special chars
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    function handlePaste(event) {
        event.preventDefault();
        event.stopPropagation();
        
        let text = '';
        if (event.clipboardData && event.clipboardData.getData) {
            text = event.clipboardData.getData('text/plain');
        } else if (window.clipboardData && window.clipboardData.getData) {
            text = window.clipboardData.getData('Text');
        }
        
        if (text) {
            if (document.queryCommandSupported('insertText')) {
                document.execCommand('insertText', false, text);
            } else {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    const textNode = document.createTextNode(text);
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        }
        
        return false;
    }
    
    // --- STATE ---
    let state = { allData: [], history: [], redoStack: [], recents: [], currentView: 'favorites', activeCategoryId: null, activeSubcategoryId: null, activePromptId: null, activeTag: null, startEditingNewPrompt: false };
    let savedRange = null;
    let itemToRename = null;
    
    // --- DOM ELEMENTS ---
    const mainArea = document.getElementById("main-content-area");
    const categoryDropdown = document.getElementById("category-dropdown");
    const imageInput = document.getElementById('imageInput');

    const linkModal = document.getElementById('linkModal');
    const linkUrlInput = document.getElementById('linkUrlInput');
    const linkModalConfirm = document.getElementById('linkModalConfirm');
    const linkModalCancel = document.getElementById('linkModalCancel');
    
    const renameModal = document.getElementById('renameModal');
    const renameModalTitle = document.getElementById('renameModalTitle');
    const renameInput = document.getElementById('renameInput');
    const renameModalConfirm = document.getElementById('renameModalConfirm');
    const renameModalCancel = document.getElementById('renameModalCancel');

    // --- FUNZIONI MODAL LINK ---
    function showLinkModal() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && selection.toString().length > 0) {
            savedRange = selection.getRangeAt(0);
        } else {
             Toast.show("Seleziona il testo da trasformare in link.", 'error');
             return false;
        }

        linkUrlInput.value = '';
        linkModal.style.display = 'flex';
        setTimeout(() => linkUrlInput.focus(), 50);
        return true;
    }

    function hideLinkModal() {
        linkModal.style.display = 'none';
        savedRange = null;
    }
    
    function applyLink(url) {
        if (!url || url.trim().length < 5) {
            Toast.show("URL non valido.", 'error');
            return;
        }
        
        let finalUrl = url.trim();
        if (!finalUrl.match(/^[a-zA-Z]+:\/\//)) {
            finalUrl = 'https://' + finalUrl;
        }

        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);

            const selectedText = savedRange.toString();
            const linkHtml = `<a href="${finalUrl}" target="_blank">${selectedText}</a>`;
            document.execCommand('insertHTML', false, linkHtml);
            
            document.querySelector('.prompt-description-container[contenteditable="true"]').focus();

            hideLinkModal();
            Toast.show("Link arancione creato con successo!", 'success', 2000);
        } else {
             Toast.show("Errore: Nessun testo selezionato.", 'error');
             hideLinkModal();
        }
    }

    // --- FUNZIONI PER RINOMINARE ---
    function showRenameModal(type, id, currentName, extraIds = {}) {
        itemToRename = { type, id, ...extraIds };
        const titles = {
            category: 'Rinomina Categoria',
            subcategory: 'Rinomina Sottocategoria',
            prompt: 'Rinomina Prompt'
        };
        renameModalTitle.textContent = titles[type] || 'Rinomina Elemento';
        renameInput.value = currentName;
        renameModal.style.display = 'flex';
        setTimeout(() => renameInput.focus(), 50);
    }

    function hideRenameModal() {
        renameModal.style.display = 'none';
        itemToRename = null;
    }

    async function handleRenameConfirm() {
        if (!itemToRename) return;
        const newName = renameInput.value.trim();
        if (!newName) {
            Toast.show("Il nome non puÃ² essere vuoto.", 'error');
            return;
        }

        const { type, id, categoryId } = itemToRename;
        const newData = JSON.parse(JSON.stringify(state.allData));
        let success = false;

        if (type === 'category') {
            const item = newData.find(c => c.id === id);
            if (item) { item.name = newName; success = true; }
        } else if (type === 'subcategory') {
            const cat = newData.find(c => c.id === categoryId);
            const item = cat?.subcategories.find(s => s.id === id);
            if (item) { item.name = newName; success = true; }
        } else if (type === 'prompt') {
            const cat = newData.find(c => c.id === state.activeCategoryId);
            const sub = cat?.subcategories.find(s => s.id === state.activeSubcategoryId);
            const item = sub?.prompts.find(p => p.id === id);
            if (item) { item.title = newName; success = true; }
        }

        if (success) {
            hideRenameModal();
            await updateStateAndSave(newData);
            Toast.show("Elemento rinominato con successo!", 'success');
        } else {
            Toast.show("Errore: elemento non trovato.", 'error');
        }
    }

    // --- UTILS PER IMMAGINI ---
    function insertBase64Image(file) {
        if (!file.type.startsWith('image/')) {
            Toast.show("Il file non Ã¨ un'immagine.", 'error');
            return;
        }
        if (file.size > 2 * 1024 * 1024) {
            Toast.show("Immagine troppo grande (Max 2MB).", 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const descriptionContainer = document.querySelector('.prompt-description-container[contenteditable="true"]');
            if (!descriptionContainer) return;
            
            const imgHtml = `<img src="${e.target.result}" style="max-width: 100%; height: auto; display: block; margin: 10px 0; border-radius: 8px;" alt="Immagine allegata al prompt">`;
            
            document.execCommand('insertHTML', false, imgHtml);
            descriptionContainer.focus();
            Toast.show("Immagine inserita (Base64).", 'success', 2000);
        };
        reader.readAsDataURL(file);
    }
    
    // --- FUNZIONI VARIABILI DINAMICHE AVANZATE ---
    function extractVariables(text) {
        // Regex cattura: {{...}} oppure [...]
        const regex = /\{\{(.*?)\}\}|\[(.*?)\]/g;
        const variables = new Map();
        let match;
        
        while ((match = regex.exec(text)) !== null) {
            const content = match[1] || match[2];
            if (!content || content.trim() === '') continue;

            const trimmedContent = content.trim();
            // Parse for options: VariableName:Option1|Option2 or VariableName:DefaultValue
            // Se c'Ã¨ ':' dividiamo nome e opzioni/default
            let varName = trimmedContent;
            let options = null;
            let defaultValue = "";

            if (trimmedContent.includes(':')) {
                const parts = trimmedContent.split(':');
                varName = parts[0].trim();
                const rest = parts.slice(1).join(':').trim(); // Ricomponi se c'erano altri :
                
                if (rest.includes('|')) {
                    // Ãˆ una lista di varianti (dropdown)
                    options = rest.split('|').map(o => o.trim());
                    defaultValue = options[0];
                } else {
                    // Ãˆ un valore di default
                    defaultValue = rest;
                }
            }

            if (!variables.has(varName)) {
                variables.set(varName, {
                    name: varName,
                    originalMatch: trimmedContent, // Ci serve per capire se Ã¨ una variante
                    options: options,
                    defaultValue: defaultValue
                });
            }
        }
        return Array.from(variables.values());
    }
    
    function renderVariableInputs(variables) {
        const container = document.getElementById('variables-container');
        if (!container) return;
        
        if (variables.length === 0) {
            container.style.display = 'none';
            container.innerHTML = '';
            return;
        }
        
        // Conserva i valori esistenti per nome
        const existingValues = {};
        container.querySelectorAll('.variable-input, .variable-select').forEach(el => {
            existingValues[el.dataset.variable] = el.value;
        });
        
        container.innerHTML = '<div class="variables-header">Variabili Dinamiche & Varianti</div>';
        
        variables.forEach(v => {
            const group = document.createElement('div');
            group.className = 'variable-group';
            
            const label = document.createElement('div');
            label.className = 'variable-label';
            label.textContent = v.name;
            label.title = v.name;
            
            let inputElement;

            if (v.options && v.options.length > 0) {
                // Render Select Dropdown
                inputElement = document.createElement('select');
                inputElement.className = 'variable-select';
                v.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    inputElement.appendChild(option);
                });
            } else {
                // Render Text Input
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'variable-input';
                inputElement.placeholder = `Valore per ${v.name}`;
                // Set default value if exists and no user input yet
                if (v.defaultValue) {
                    inputElement.value = v.defaultValue;
                }
            }

            inputElement.dataset.variable = v.name;
            
            // Restore existing value if valid
            if (existingValues[v.name]) {
                inputElement.value = existingValues[v.name];
            }
            
            group.appendChild(label);
            group.appendChild(inputElement);
            container.appendChild(group);
        });
        
        container.classList.add('active');
        container.style.display = 'flex';
    }

    // --- FUNZIONE DI SALVATAGGIO OTTIMIZZATA ---
    async function updateStateAndSave(newData, { newActiveIds = {}, saveHistory = true } = {}) {
        Loader.show();
        try {
            if (saveHistory) {
                state.redoStack = [];
                state.history.push(JSON.parse(JSON.stringify({ 
                    allData: state.allData,
                    recents: state.recents,
                    activeCategoryId: state.activeCategoryId,
                    activeSubcategoryId: state.activeSubcategoryId,
                    activePromptId: state.activePromptId,
                    currentView: state.currentView
                })));
                if (state.history.length > 30) state.history.shift();
            }
            
            state.allData = newData;
            Object.assign(state, newActiveIds);
            
            // Attendiamo che IndexedDB confermi la scrittura
            await Database.save(state.allData);
            
            localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents));
            renderUI();
            return true;
        } catch (error) {
            console.error("Errore critico durante il salvataggio:", error);
            Toast.show("Errore durante il salvataggio dei dati.", 'error', 5000);
            return false;
        } finally {
            Loader.hide();
        }
    }
    
    // --- RENDER FUNCTIONS ---
    function renderUI() {
        renderCategoryDropdown();
        switch(state.currentView) {
            case 'favorites': 
                mainArea.className = 'view-mode-two-column'; 
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`; 
                renderSpecialView('favorites'); 
                break;
            case 'recents': 
                mainArea.className = 'view-mode-two-column'; 
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`; 
                renderSpecialView('recents'); 
                break;
            case 'tags':
                mainArea.className = 'view-mode-two-column';
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`;
                renderTagsView();
                break;
            case 'search':
                mainArea.className = 'view-mode-two-column';
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`;
                renderSearchView();
                break;
            default: 
                mainArea.className = 'view-mode-three-column'; 
                renderColumnsView(); 
                break;
        }
        updateUndoRedoButtons();
    }

    function renderColumnsView() {
        mainArea.innerHTML = `<div id="col-subcategories" class="column"></div> <div id="col-prompts" class="column"></div> <div id="col-detail" class="column"></div>`;
        renderSubcategoryColumn();
        renderPromptColumn();
        renderDetailColumn();
    }
    
    function renderCategoryDropdown() {
        categoryDropdown.innerHTML = "";
        const createOption = (value, text) => { const opt = document.createElement('option'); opt.value = value; opt.textContent = text; return opt; };
        
        categoryDropdown.appendChild(createOption('favorites', 'â­ Preferiti'));
        categoryDropdown.appendChild(createOption('recents', 'ðŸ•’ Recenti'));
        categoryDropdown.appendChild(createOption('tags', 'ðŸ·ï¸ Tag'));
        
        if (state.currentView === 'search') {
            const searchOpt = createOption('search', 'ðŸ” Risultati Ricerca');
            searchOpt.selected = true;
            categoryDropdown.appendChild(searchOpt);
        }

        if (state.allData.length > 0) {
            const separator1 = createOption('separator', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'); separator1.disabled = true; categoryDropdown.appendChild(separator1);
            
            // Logica per mettere "Best" e "Prova" in cima
            const priorityNames = ["Best", "Prova"];
            const priorityCats = [];
            const otherCats = [];

            state.allData.forEach(cat => {
                if (priorityNames.includes(cat.name.trim())) {
                    priorityCats.push(cat);
                } else {
                    otherCats.push(cat);
                }
            });

            // Ordina priority (Best prima di Prova)
            priorityCats.sort((a, b) => {
                return priorityNames.indexOf(a.name.trim()) - priorityNames.indexOf(b.name.trim());
            });

            // Ordina altri alfabeticamente
            otherCats.sort((a, b) => a.name.localeCompare(b.name));

            // Render Priority
            priorityCats.forEach(cat => categoryDropdown.appendChild(createOption(cat.id, cat.name)));

            // Separatore se ci sono altre categorie
            if (priorityCats.length > 0 && otherCats.length > 0) {
                 const separator2 = createOption('separator2', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'); separator2.disabled = true; categoryDropdown.appendChild(separator2);
            }

            // Render Altri
            otherCats.forEach(cat => categoryDropdown.appendChild(createOption(cat.id, cat.name)));
        }
        
        if (state.currentView !== 'columns' && ['favorites', 'recents', 'tags', 'search'].includes(state.currentView)) {
             categoryDropdown.value = state.currentView;
        } else if (state.activeCategoryId) {
            categoryDropdown.value = state.activeCategoryId;
        } else if (state.allData.length > 0) {
            // Seleziona il primo disponibile (prioritÃ  o altro)
            const firstAvailable = state.allData.find(c => c.name === "Best") || state.allData.find(c => c.name === "Prova") || state.allData[0];
            if (firstAvailable) categoryDropdown.value = firstAvailable.id;
        }
    }
    
    function renderSubcategoryColumn() {
        const col = document.getElementById('col-subcategories');
        const activeCategory = state.allData.find(c => c.id === state.activeCategoryId);
        if (!activeCategory) { col.innerHTML = '<div class="initial-message">Seleziona una categoria</div>'; return; }
        col.innerHTML = `
            <div class="column-header">
                <div class="column-header-title">
                    <h3>${activeCategory.name}</h3>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-cat-btn" title="Rinomina Categoria"></i>
                    <i class="fa-solid fa-trash-can delete-icon" id="delete-cat-btn" title="Elimina Categoria"></i>
                </div>
                <button class="add-button" id="add-subcat-btn" title="Aggiungi Sottocategoria">
                    <i class="fa-solid fa-plus"></i> Sottocategoria
                </button>
            </div>
            <div class="column-content"></div>`;
        document.getElementById('add-subcat-btn').onclick = () => addSubcategory(activeCategory.id);
        document.getElementById('rename-cat-btn').onclick = () => showRenameModal('category', activeCategory.id, activeCategory.name);
        document.getElementById('delete-cat-btn').onclick = () => deleteCategory(activeCategory.id);

        const listContainer = col.querySelector('.column-content');
        if (!activeCategory.subcategories?.length) { listContainer.innerHTML = '<div class="initial-message">Nessuna sottocategoria</div>'; return; }
        activeCategory.subcategories.sort((a,b)=>a.name.localeCompare(b.name)).forEach(sub => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${sub.id===state.activeSubcategoryId?'active':''}`; 
            item.innerHTML = `<span class="item-name">${sub.name}</span>`; 
            item.onclick = () => { 
                state.currentView = 'columns';
                state.activeSubcategoryId = sub.id; 
                state.activePromptId = sub.prompts?.sort((a,b)=>a.title.localeCompare(b.title))[0]?.id || null; 
                renderUI(); 
            }; 
            listContainer.appendChild(item); 
        });
    }

    function renderPromptColumn() {
        const col = document.getElementById('col-prompts');
        const activeCategory = state.allData.find(c=>c.id===state.activeCategoryId);
        const activeSub = activeCategory?.subcategories.find(s=>s.id===state.activeSubcategoryId);
        if (!activeSub) { col.innerHTML = '<div class="initial-message">Seleziona una sottocategoria</div>'; return; }
        col.innerHTML = `
            <div class="column-header">
                 <div class="column-header-title">
                    <h3>${activeSub.name}</h3>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-subcat-btn" title="Rinomina Sottocategoria"></i>
                    <i class="fa-solid fa-trash-can delete-icon" id="delete-subcat-btn" title="Elimina Sottocategoria"></i>
                </div>
                <button class="add-button" id="add-prompt-btn" title="Aggiungi Prompt">
                    <i class="fa-solid fa-plus"></i> Prompt
                </button>
            </div>
            <div class="column-content"></div>`;
        
        document.getElementById('rename-subcat-btn').onclick = () => showRenameModal('subcategory', activeSub.id, activeSub.name, { categoryId: activeCategory.id });
        document.getElementById('delete-subcat-btn').onclick = () => deleteSubcategory(activeSub.id, activeCategory.id);
        const addPromptBtn = document.getElementById('add-prompt-btn');
        if (addPromptBtn) {
            addPromptBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                addNewPrompt(activeSub.id, state.activeCategoryId);
            };
        }
        
        const listContainer = col.querySelector('.column-content');
        if (!activeSub.prompts?.length) { listContainer.innerHTML = '<div class="initial-message">Nessun prompt</div>'; return; }
        activeSub.prompts.sort((a,b)=>a.title.localeCompare(b.title)).forEach(p => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${p.id===state.activePromptId?'active':''}`; 
            
            let tagsHtml = '';
            if (p.tags && p.tags.length > 0) {
                tagsHtml = '<div class="tags-container">';
                p.tags.forEach(tag => {
                    tagsHtml += `<span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span>`;
                });
                tagsHtml += '</div>';
            }
            
            item.innerHTML = `<div class="item-name">${p.title}</div>${tagsHtml}`; 
            item.onclick = () => { 
                state.activePromptId = p.id; 
                trackRecentPrompt(p.id, activeSub.id, state.activeCategoryId); 
                renderUI(); 
            }; 
            listContainer.appendChild(item); 
        });
    }

    function renderDetailColumn() {
        const colId = (state.currentView === 'favorites' || state.currentView === 'recents' || state.currentView === 'tags' || state.currentView === 'search') ? 'col-special-detail' : 'col-detail';
        const col = document.getElementById(colId);
        if (!col) return;
        
        const cat = state.allData.find(c => c.id === state.activeCategoryId);
        const sub = cat?.subcategories?.find(s => s.id === state.activeSubcategoryId);
        const promptItem = sub?.prompts?.find(p => p.id === state.activePromptId);

        if (!promptItem) { col.innerHTML = '<div class="initial-message">Seleziona un prompt</div>'; return; }
        
        if (!promptItem.tags) promptItem.tags = [];
        
        col.innerHTML = `
            <div class="prompt-detail-view">
                <div class="prompt-header"><h3>Dettagli Prompt</h3>
                    <div class="prompt-actions-toolbar">
                        <i id="edit-prompt-btn" class="fa-solid fa-pencil" title="Modifica Testo"></i>
                        <i id="copy-prompt-btn" class="fa-solid fa-copy" title="Copia Testo con Variabili"></i>
                        <i id="fav-prompt-btn" class="${promptItem.favorite ? "fa-solid" : "fa-regular"} fa-star" title="Preferito"></i>
                        <i id="quick-save-best-btn" class="fa-solid fa-trophy" title="Salva in 'Best' ðŸ†"></i>
                        <i id="quick-save-prova-btn" class="fa-solid fa-vial" title="Salva in 'Prova'"></i>
                        <i id="delete-prompt-btn" class="fa-solid fa-trash-can" title="Elimina"></i>
                    </div>
                </div>
                <div class="prompt-title-section">
                    <h1>${promptItem.title}</h1>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-prompt-btn" title="Rinomina Prompt"></i>
                </div>
                <div class="tag-input-section">
                    <div class="tag-input-wrapper">
                        <input type="text" id="tag-input" placeholder="Aggiungi un tag (es: SEO, Marketing, AI)">
                        <button id="add-tag-btn"><i class="fa-solid fa-plus"></i> Aggiungi</button>
                    </div>
                    <div class="current-tags" id="current-tags-container"></div>
                </div>
                
                <div id="variables-container" class="variables-container"></div>

                <div id="formatting-toolbar">
                    <button data-command="bold" title="Grassetto (B)"><i class="fa-solid fa-bold"></i></button>
                    <button data-command="italic" title="Corsivo (I)"><i class="fa-solid fa-italic"></i></button>
                    <button data-command="underline" title="Sottolineato (U)"><i class="fa-solid fa-underline"></i></button>
                    <button data-command="insertUnorderedList" title="Lista puntata"><i class="fa-solid fa-list-ul"></i></button>
                    <button data-command="fontSizeUp" title="Aumenta dimensione testo (+)"><i class="fa-solid fa-plus"></i></button>
                    <button data-command="fontSizeDown" title="Diminuisci dimensione testo (-)"><i class="fa-solid fa-minus"></i></button>
                    <button data-command="showLinkModal" id="btn-create-link" title="Aggiungi Link (@)"><i class="fa-solid fa-link"></i></button>
                    <button data-command="unlink" title="Rimuovi Link"><i class="fa-solid fa-link-slash"></i></button>
                    <button data-command="insertImage" id="btn-insert-image" title="Aggiungi Immagine (Carica)"><i class="fa-regular fa-image"></i></button>
                    <button id="color-btn" title="Colore Testo"><i class="fa-solid fa-palette"></i></button>
                    <input type="color" id="colorPicker" value="#FFFFFF" style="visibility: hidden; width: 0; height: 0; padding: 0; border: none;">
                    <button id="btnSaveChanges" class="add-button">Salva</button>
                </div>
                <div class="prompt-description-container" contenteditable="false" id="detail-description">${promptItem.description || ""}</div>
            </div>`;
        attachDetailViewListeners(promptItem, sub, cat);
        renderCurrentTags(promptItem);
        
        // Inizializza variabili
        const initialVars = extractVariables(promptItem.description || "");
        renderVariableInputs(initialVars);

        if (state.startEditingNewPrompt) {
            const descriptionContainer = document.getElementById('detail-description');
            if (descriptionContainer) {
                descriptionContainer.contentEditable = 'true';
                document.getElementById('formatting-toolbar')?.classList.add('show');
                document.getElementById('btnSaveChanges')?.classList.add('show');
                descriptionContainer.focus();
            }
            state.startEditingNewPrompt = false;
        }
    }
    
    function renderCurrentTags(promptItem) {
        const container = document.getElementById('current-tags-container');
        if (!container) return;
        
        container.innerHTML = '';
        if (promptItem.tags && promptItem.tags.length > 0) {
            promptItem.tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag-badge-removable';
                tagEl.style.backgroundColor = getTagColor(tag);
                tagEl.innerHTML = `${tag} <i class="fa-solid fa-xmark"></i>`;
                tagEl.onclick = () => removeTag(promptItem, tag);
                container.appendChild(tagEl);
            });
        }
    }
    
    async function addTag(promptItem, tagName) {
        if (!tagName || tagName.trim().length === 0) {
            Toast.show("Inserisci un nome per il tag.", 'error');
            return;
        }
        
        const cleanTag = tagName.trim().toLowerCase();
        
        if (!promptItem.tags) promptItem.tags = [];
        
        if (promptItem.tags.includes(cleanTag)) {
            Toast.show("Tag giÃ  presente!", 'info');
            return;
        }
        
        const newData = JSON.parse(JSON.stringify(state.allData));
        const cat = newData.find(c => c.id === state.activeCategoryId);
        const sub = cat?.subcategories.find(s => s.id === state.activeSubcategoryId);
        const prompt = sub?.prompts.find(p => p.id === promptItem.id);
        
        if (prompt) {
            if (!prompt.tags) prompt.tags = [];
            prompt.tags.push(cleanTag);
            await updateStateAndSave(newData, { saveHistory: false });
            Toast.show(`Tag "${cleanTag}" aggiunto!`, 'success', 1500);
        }
    }
    
    async function removeTag(promptItem, tagName) {
        const newData = JSON.parse(JSON.stringify(state.allData));
        const cat = newData.find(c => c.id === state.activeCategoryId);
        const sub = cat?.subcategories.find(s => s.id === state.activeSubcategoryId);
        const prompt = sub?.prompts.find(p => p.id === promptItem.id);
        
        if (prompt && prompt.tags) {
            prompt.tags = prompt.tags.filter(t => t !== tagName);
            await updateStateAndSave(newData, { saveHistory: false });
            Toast.show(`Tag "${tagName}" rimosso!`, 'info', 1500);
        }
    }
    
    function renderTagsView() {
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>ðŸ·ï¸ Filtra per Tag</h3></div><div class="column-content"></div>`;
        
        const allTags = new Set();
        state.allData.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                sub.prompts?.forEach(p => {
                    if (p.tags) {
                        p.tags.forEach(tag => allTags.add(tag));
                    }
                });
            });
        });
        
        const listContainer = colList.querySelector('.column-content');
        
        if (allTags.size === 0) {
            listContainer.innerHTML = '<div class="initial-message">Nessun tag disponibile</div>';
            document.getElementById('col-special-detail').innerHTML = '<div class="initial-message">Aggiungi tag ai tuoi prompt</div>';
            return;
        }
        
        const sortedTags = Array.from(allTags).sort();
        
        if (!state.activeTag || !allTags.has(state.activeTag)) {
            state.activeTag = sortedTags[0];
        }
        
        sortedTags.forEach(tag => {
            const item = document.createElement('div');
            item.className = `item-container ${tag === state.activeTag ? 'active' : ''}`;
            item.innerHTML = `<span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span>`;
            item.onclick = () => {
                state.activeTag = tag;
                renderTagsView();
            };
            listContainer.appendChild(item);
        });
        
        renderPromptsForTag(state.activeTag);
    }
    
    function renderPromptsForTag(tagName) {
        const colDetail = document.getElementById('col-special-detail');
        colDetail.innerHTML = `<div class="column-header"><h3>Prompt con tag: <span class="tag-badge" style="background-color: ${getTagColor(tagName)}">${tagName}</span></h3></div><div class="column-content"></div>`;
        
        const items = [];
        state.allData.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                sub.prompts?.forEach(p => {
                    if (p.tags && p.tags.includes(tagName)) {
                        items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id });
                    }
                });
            });
        });
        
        items.sort((a, b) => a.title.localeCompare(b.title));
        
        const listContainer = colDetail.querySelector('.column-content');
        
        if (items.length === 0) {
            listContainer.innerHTML = '<div class="initial-message">Nessun prompt con questo tag</div>';
            return;
        }
        
        items.forEach(p => {
            const item = document.createElement('div');
            item.className = 'item-container';
            item.innerHTML = `<div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div>`;
            item.onclick = () => {
                state.activeCategoryId = p.catId;
                state.activeSubcategoryId = p.subId;
                state.activePromptId = p.id;
                state.currentView = 'tags';
                trackRecentPrompt(p.id, p.subId, p.catId);
                renderUI();
            };
            listContainer.appendChild(item);
        });
    }

    function renderSearchView() {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>ðŸ” Risultati per: "${query}"</h3></div><div class="column-content"></div>`;
        
        if (!query) {
            colList.querySelector('.column-content').innerHTML = '<div class="initial-message">Digita qualcosa per cercare...</div>';
            document.getElementById('col-special-detail').innerHTML = '<div class="initial-message"></div>';
            return;
        }

        const items = [];
        state.allData.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                sub.prompts?.forEach(p => {
                    const matchTitle = p.title.toLowerCase().includes(query);
                    const matchDesc = p.description.toLowerCase().includes(query);
                    const matchTags = p.tags && p.tags.some(t => t.toLowerCase().includes(query));
                    
                    if (matchTitle || matchDesc || matchTags) {
                        items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id });
                    }
                });
            });
        });
        
        items.sort((a, b) => a.title.localeCompare(b.title));
        
        const listContainer = colList.querySelector('.column-content');
        
        if (items.length === 0) {
            listContainer.innerHTML = '<div class="initial-message">Nessun risultato trovato</div>';
            document.getElementById('col-special-detail').innerHTML = '<div class="initial-message">Prova con un altro termine</div>';
            return;
        }

        items.forEach(p => {
            const item = document.createElement("div");
            item.className = `item-container ${p.id === state.activePromptId ? 'active' : ''}`;
            
            let tagsHtml = '';
            if (p.tags && p.tags.length > 0) {
                tagsHtml = '<div class="tags-container">';
                p.tags.forEach(tag => {
                    tagsHtml += `<span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span>`;
                });
                tagsHtml += '</div>';
            }
            
            item.innerHTML = `<div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div>${tagsHtml}`;
            item.onclick = () => {
                state.activeCategoryId = p.catId; 
                state.activeSubcategoryId = p.subId; 
                state.activePromptId = p.id;
                trackRecentPrompt(p.id, p.subId, p.catId);
                renderUI(); 
            };
            listContainer.appendChild(item);
        });
        
        renderDetailColumn();
    }
    
    function renderSpecialView(type) {
        const titles = { favorites: "Preferiti", recents: "Recenti" };
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>${titles[type]}</h3></div><div class="column-content"></div>`;
        
        let items = [];
        if (type === 'favorites') {
            state.allData.forEach(cat => cat.subcategories?.forEach(sub => sub.prompts?.forEach(p => { 
                if (p.favorite) items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id }); 
            })));
            items.sort((a,b)=>a.title.localeCompare(b.title));
        } else {
            state.recents.forEach(r => {
                const cat = state.allData.find(c => c.id === r.catId);
                const sub = cat?.subcategories.find(s => s.id === r.subId);
                const p = sub?.prompts.find(p_item => p_item.id === r.promptId);
                if (p) items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id, accessTime: r.timestamp || 0 });
            });
            items.sort((a,b)=>b.accessTime - a.accessTime); 
        }
        
        const listContainer = colList.querySelector('.column-content');
        if (!items.length) { 
            listContainer.innerHTML = `<div class="initial-message">Nessun elemento in ${titles[type]}</div>`; 
            document.getElementById('col-special-detail').innerHTML = '<div class="initial-message">Nessun prompt da visualizzare</div>'; 
            state.activePromptId = null;
            state.activeSubcategoryId = null;
            state.activeCategoryId = null;
            return; 
        }

        const currentActiveItem = items.find(p => p.id === state.activePromptId);
        if (!currentActiveItem) {
            state.activePromptId = items[0].id;
            state.activeSubcategoryId = items[0].subId;
            state.activeCategoryId = items[0].catId;
        }

        items.forEach(p => {
            const item = document.createElement("div");
            item.className = `item-container ${p.id === state.activePromptId ? 'active' : ''}`;
            
            let tagsHtml = '';
            if (p.tags && p.tags.length > 0) {
                tagsHtml = '<div class="tags-container">';
                p.tags.forEach(tag => {
                    tagsHtml += `<span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span>`;
                });
                tagsHtml += '</div>';
            }
            
            item.innerHTML = `<div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div>${tagsHtml}`;
            item.onclick = () => {
                state.activeCategoryId = p.catId; 
                state.activeSubcategoryId = p.subId; 
                state.activePromptId = p.id;
                trackRecentPrompt(p.id, p.subId, p.catId);
                renderUI(); 
            };
            listContainer.appendChild(item);
        });
        
        renderDetailColumn();
    }
    
    function attachDetailViewListeners(promptItem, sub, cat) {
        const colId = (state.currentView === 'favorites' || state.currentView === 'recents' || state.currentView === 'tags' || state.currentView === 'search') ? 'col-special-detail' : 'col-detail';
        const col = document.getElementById(colId);
        if (!col) return;

        const descriptionContainer = col.querySelector("#detail-description");
        if (!descriptionContainer) return;
        
        document.getElementById('rename-prompt-btn').onclick = () => showRenameModal('prompt', promptItem.id, promptItem.title);

        const tagInput = document.getElementById('tag-input');
        const addTagBtn = document.getElementById('add-tag-btn');
        
        if (tagInput && addTagBtn) {
            addTagBtn.onclick = () => {
                addTag(promptItem, tagInput.value);
                tagInput.value = '';
            };
            
            tagInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(promptItem, tagInput.value);
                    tagInput.value = '';
                }
            };
        }
        
        // Listener per scansione variabili mentre si digita
        descriptionContainer.addEventListener('input', () => {
            const text = descriptionContainer.innerText;
            const vars = extractVariables(text);
            renderVariableInputs(vars);
        });

        col.querySelector("#edit-prompt-btn").onclick = () => {
            const isEditing = descriptionContainer.contentEditable === 'true';
            descriptionContainer.contentEditable = isEditing ? 'false' : 'true';
            descriptionContainer.setAttribute('contenteditable', isEditing ? 'false' : 'true');

            col.querySelector("#formatting-toolbar").classList.toggle("show", !isEditing);
            col.querySelector("#btnSaveChanges").classList.toggle("show", !isEditing);
            if (!isEditing) {
                 descriptionContainer.focus();
            } else {
                 Toast.show("Modifica annullata. Ricorda di cliccare Salva.", 'info');
            }
        };

        col.querySelector("#btnSaveChanges").onclick = async () => {
            const newData = JSON.parse(JSON.stringify(state.allData));
            const promptToUpdate = newData.find(c=>c.id===cat.id)?.subcategories.find(s=>s.id===sub.id)?.prompts.find(p_item=>p_item.id===promptItem.id);
            if(promptToUpdate) {
                promptToUpdate.description = descriptionContainer.innerHTML;
            }
            descriptionContainer.contentEditable = 'false'; 
            descriptionContainer.setAttribute('contenteditable', 'false');
            col.querySelector("#formatting-toolbar").classList.remove("show");
            col.querySelector("#btnSaveChanges").classList.remove("show");

            await updateStateAndSave(newData);
            Toast.show("Prompt salvato!", 'success');
        };

        col.querySelectorAll("#formatting-toolbar button[data-command]").forEach(btn => {
            btn.onclick = e => { 
                e.preventDefault(); 
                const command = btn.dataset.command;

                if (command === 'showLinkModal') {
                    showLinkModal();
                } 
                else if (command === 'fontSizeUp') {
                    document.execCommand('fontSize', false, '7'); 
                } 
                else if (command === 'fontSizeDown') {
                    document.execCommand('fontSize', false, '1');
                }
                else if (command === 'insertImage') {
                    imageInput.click();
                }
                else {
                    document.execCommand(command, false, null); 
                }
                if (command !== 'showLinkModal') {
                    descriptionContainer.focus(); 
                }
            };
        });
        
        const colorPicker = col.querySelector("#colorPicker");
        col.querySelector("#color-btn").onclick = () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().length > 0) {
                savedRange = selection.getRangeAt(0);
            } else {
                savedRange = null;
            }
            colorPicker.click();
        };

        colorPicker.onchange = () => {
            descriptionContainer.focus();
            if (savedRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);
            }
            document.execCommand('foreColor', false, colorPicker.value);
            savedRange = null;
        };

        // COPY LOGIC AVANZATA CON SOSTITUZIONE VARIABILI E VARIANTI
        col.querySelector("#copy-prompt-btn").onclick = () => {
            let textToCopy = descriptionContainer.innerText;
            const variableInputs = document.querySelectorAll('.variable-input, .variable-select');
            
            if (variableInputs.length > 0) {
                variableInputs.forEach(input => {
                    const varName = input.dataset.variable;
                    const value = input.value.trim();
                    
                    if (value) {
                         // Sostituisci {{Nome}}, {{Nome:Opz1|Opz2}} e [Nome...]
                         // Utilizziamo una regex piÃ¹ permissiva per trovare il blocco originale
                         const escapedName = escapeRegExp(varName);
                         const regex = new RegExp(`(\\{\\{|\\[)\\s*${escapedName}(\\s*|:.*?)(\\]|\\}\\})`, 'g');
                         
                         textToCopy = textToCopy.replace(regex, value);
                    }
                });
            }

            const tempElement = document.createElement('textarea');
            tempElement.value = textToCopy;
            tempElement.style.position = 'fixed'; tempElement.style.top = '0'; tempElement.style.left = '0'; tempElement.style.opacity = '0';
            document.body.appendChild(tempElement); tempElement.focus(); tempElement.select();
            try {
                const successful = document.execCommand('copy');
                Toast.show(successful ? "Copiato con variabili!" : "Errore nella copia.", successful ? 'success' : 'error');
            } catch (err) { Toast.show("Errore nella copia.", 'error'); } 
            finally { document.body.removeChild(tempElement); }
        };
        
        col.querySelector("#delete-prompt-btn").onclick = () => deletePrompt(promptItem.id, sub.id, cat.id);
        col.querySelector("#fav-prompt-btn").onclick = async () => {
             const newData = JSON.parse(JSON.stringify(state.allData));
             const promptToUpdate = newData.find(c=>c.id===cat.id)?.subcategories.find(s=>s.id===sub.id)?.prompts.find(p_item=>p_item.id===promptItem.id);
             if(promptToUpdate) {
                promptToUpdate.favorite = !promptToUpdate.favorite;
             }
             await updateStateAndSave(newData, { saveHistory: false });
        };
        
        // --- LOGICA SALVATAGGIO AUTOMATICO: PROVA ---
        col.querySelector("#quick-save-prova-btn").onclick = async () => {
            quickSaveToCategory('Prova');
        };

        // --- LOGICA SALVATAGGIO AUTOMATICO: BEST ---
        col.querySelector("#quick-save-best-btn").onclick = async () => {
            quickSaveToCategory('Best');
        };

        // Helper function per il quick save
        async function quickSaveToCategory(targetCategoryName) {
             Loader.show();
            try {
                // 1. Catturiamo il contenuto attuale
                const currentContent = descriptionContainer.innerHTML || promptItem.description;
                
                const newData = JSON.parse(JSON.stringify(state.allData));
                
                // 2. Cerca o Crea Categoria Target
                let catIndex = newData.findIndex(c => c.name.trim().toLowerCase() === targetCategoryName.toLowerCase());
                
                if (catIndex === -1) {
                    const newCat = { id: `cat_${Date.now()}_${targetCategoryName}`, name: targetCategoryName, subcategories: [] };
                    newData.push(newCat);
                    catIndex = newData.length - 1;
                }
                
                // 3. Cerca o Crea Sottocategoria "Inbox"
                let subIndex = newData[catIndex].subcategories.findIndex(s => s.name === 'Inbox');
                
                if (subIndex === -1) {
                    const newSub = { id: `sub_${Date.now()}_inbox`, name: 'Inbox', prompts: [] };
                    newData[catIndex].subcategories.push(newSub);
                    subIndex = newData[catIndex].subcategories.length - 1;
                }
                
                // 4. Crea nuovo Prompt come copia
                const newPrompt = { 
                    id: `p_${Date.now()}`, 
                    title: promptItem.title + " (Copy)", 
                    description: currentContent, 
                    favorite: false, 
                    tags: [...(promptItem.tags || [])] 
                };
                
                newData[catIndex].subcategories[subIndex].prompts.push(newPrompt);
                
                // 5. Salva
                await updateStateAndSave(newData, { saveHistory: false });
                Toast.show(`Salvato in ${targetCategoryName} > Inbox!`, "success");
                
            } catch (e) {
                console.error(e);
                Toast.show("Errore nel salvataggio automatico.", "error");
            } finally {
                Loader.hide();
            }
        }

        descriptionContainer.addEventListener('paste', handlePaste, false);
        
        descriptionContainer.addEventListener('dragover', e => { 
            if (descriptionContainer.contentEditable === 'true') {
                e.preventDefault(); 
                descriptionContainer.classList.add('drag-over'); 
            }
        });
        descriptionContainer.addEventListener('dragleave', () => { 
            descriptionContainer.classList.remove('drag-over'); 
        });
        
        descriptionContainer.addEventListener('drop', e => {
            if (descriptionContainer.contentEditable === 'true') {
                if (e.dataTransfer.types.includes("Files")) {
                    e.preventDefault();
                    e.stopPropagation();
                    descriptionContainer.classList.remove('drag-over');
                    if (e.dataTransfer.files.length > 0) {
                        insertBase64Image(e.dataTransfer.files[0]);
                    }
                } else {
                    descriptionContainer.classList.remove('drag-over');
                }
            }
        });
    }
    
    function trackRecentPrompt(promptId, subId, catId) {
        const timestamp = Date.now();
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        state.recents.unshift({ promptId, subId, catId, timestamp });
        if (state.recents.length > 20) state.recents.pop();
    }
    
    // --- DATA MANIPULATION ---
    async function addCategory() { 
        const name = window.prompt("Nome nuova categoria:"); 
        if (!name?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        const newCategory = { id: `cat_${Date.now()}`, name: name.trim(), subcategories: [] }; 
        const newData = [...state.allData, newCategory]; 
        await updateStateAndSave(newData, { newActiveIds: { currentView: 'columns', activeCategoryId: newCategory.id, activeSubcategoryId: null, activePromptId: null } }); 
        Toast.show(`Categoria "${newCategory.name}" aggiunta!`, 'success');
    }

    async function deleteCategory(categoryId) {
        const categoryToDelete = state.allData.find(c => c.id === categoryId);
        if (!categoryToDelete) return;
        if (!window.confirm(`Sei sicuro di voler eliminare la categoria "${categoryToDelete.name}"? Tutti i suoi contenuti verranno persi.`)) return;
        const newData = state.allData.filter(c => c.id !== categoryId);
        let newActiveIds = {};
        if (state.activeCategoryId === categoryId) {
            if (newData.length > 0) {
                const firstCategory = newData.sort((a,b) => a.name.localeCompare(b.name))[0];
                const firstSubcategory = firstCategory.subcategories?.sort((a,b) => a.name.localeCompare(b.name))[0];
                newActiveIds = {
                    currentView: 'columns',
                    activeCategoryId: firstCategory.id,
                    activeSubcategoryId: firstSubcategory?.id || null,
                    activePromptId: firstSubcategory?.prompts?.sort((a,b) => a.title.localeCompare(b.title))[0]?.id || null
                };
            } else {
                 newActiveIds = { currentView: 'favorites', activeCategoryId: null, activeSubcategoryId: null, activePromptId: null };
            }
        }
        await updateStateAndSave(newData, { newActiveIds });
        Toast.show(`Categoria "${categoryToDelete.name}" eliminata!`, 'info');
    }
    
    async function addSubcategory(categoryId) { 
        const name = window.prompt("Nome nuova sottocategoria:"); 
        if (!name?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const cat = newData.find(c => c.id === categoryId); 
        if (!cat) { Toast.show("Errore: categoria non trovata.", 'error'); return; }
        const newSub = { id: `sub_${Date.now()}`, name: name.trim(), prompts: [] }; 
        if (!Array.isArray(cat.subcategories)) cat.subcategories = [];
        cat.subcategories.push(newSub); 
        await updateStateAndSave(newData, { newActiveIds: { activeSubcategoryId: newSub.id, activePromptId: null } }); 
        Toast.show(`Sottocategoria "${newSub.name}" aggiunta!`, 'success');
    }

    async function deleteSubcategory(subcategoryId, categoryId) {
        const newData = JSON.parse(JSON.stringify(state.allData));
        const cat = newData.find(c => c.id === categoryId);
        if (!cat || !Array.isArray(cat.subcategories)) return;
        const subToDelete = cat.subcategories.find(s => s.id === subcategoryId);
        if (!subToDelete) return;
        if (!window.confirm(`Sei sicuro di voler eliminare la sottocategoria "${subToDelete.name}"?`)) return;
        const subIndex = cat.subcategories.findIndex(s => s.id === subcategoryId);
        cat.subcategories.splice(subIndex, 1);
        let newActiveIds = {};
        if (state.activeSubcategoryId === subcategoryId) {
            const newActiveSub = cat.subcategories[subIndex] || cat.subcategories[subIndex - 1] || cat.subcategories[0] || null;
            newActiveIds = {
                activeSubcategoryId: newActiveSub?.id || null,
                activePromptId: newActiveSub?.prompts?.sort((a,b) => a.title.localeCompare(b.title))[0]?.id || null
            };
        }
        await updateStateAndSave(newData, { newActiveIds });
        Toast.show(`Sottocategoria "${subToDelete.name}" eliminata!`, 'info');
    }
    
    async function addNewPrompt(subcategoryId, categoryId) { 
        const title = window.prompt("Titolo nuovo prompt:"); 
        if (!title?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const cat = newData.find(c => c.id === categoryId);
        const sub = cat?.subcategories.find(s => s.id === subcategoryId);
        if (!sub) return;
        const newPrompt = { id: `p_${Date.now()}`, title: title.trim(), description: "", favorite: false, tags: [] }; 
        if (!Array.isArray(sub.prompts)) sub.prompts = [];
        sub.prompts.push(newPrompt); 
        state.startEditingNewPrompt = true; 
        await updateStateAndSave(newData, { newActiveIds: { activePromptId: newPrompt.id } }); 
        Toast.show(`Prompt "${newPrompt.title}" aggiunto!`, 'success');
    }
    
    async function deletePrompt(promptId, subId, catId) { 
        if (!window.confirm("Sei sicuro di voler eliminare questo prompt?")) return; 
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const sub = newData.find(c=>c.id===catId)?.subcategories.find(s=>s.id===subId); 
        if (!sub || !Array.isArray(sub.prompts)) return;
        const promptIndex = sub.prompts.findIndex(p_item => p_item.id === promptId); 
        if (promptIndex === -1) return;
        sub.prompts.splice(promptIndex, 1); 
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        const newActivePromptId = sub.prompts[promptIndex]?.id || sub.prompts[promptIndex-1]?.id || sub.prompts[0]?.id || null; 
        let newActiveIds = { activePromptId: newActivePromptId };
        await updateStateAndSave(newData, { newActiveIds }); 
        Toast.show("Prompt eliminato!", 'info');
    }

    // --- TOOL FUNCTIONS ---
    function updateUndoRedoButtons() { document.getElementById('btnAnnulla').disabled = state.history.length === 0; document.getElementById('btnRipristina').disabled = state.redoStack.length === 0; }
    
    async function performUndo() { 
        if (state.history.length === 0) return; 
        const lastState = state.history.pop(); 
        state.redoStack.push(JSON.parse(JSON.stringify({ 
            allData: state.allData, 
            recents: state.recents, 
            activeCategoryId: state.activeCategoryId, 
            activeSubcategoryId: state.activeSubcategoryId, 
            activePromptId: state.activePromptId, 
            currentView: state.currentView 
        }))); 
        Object.assign(state, lastState); 
        await Database.save(state.allData); 
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); 
        renderUI(); 
        Toast.show("Annullato!", 'info', 1500);
    }

    async function performRedo() { 
        if (state.redoStack.length === 0) return; 
        const nextState = state.redoStack.pop(); 
        state.history.push(JSON.parse(JSON.stringify({ 
            allData: state.allData, 
            recents: state.recents, 
            activeCategoryId: state.activeCategoryId, 
            activeSubcategoryId: state.activeSubcategoryId, 
            activePromptId: state.activePromptId, 
            currentView: state.currentView 
        }))); 
        Object.assign(state, nextState); 
        await Database.save(state.allData); 
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); 
        renderUI(); 
        Toast.show("Ripristinato!", 'info', 1500);
    }

    function backupData() { 
        if(state.allData.length === 0) { Toast.show("Nessun dato da esportare.", "error"); return; } 
        const dataStr = JSON.stringify(state.allData, null, 2); 
        const blob = new Blob([dataStr], { type: "application/json" }); 
        const url = URL.createObjectURL(blob); 
        const a = document.createElement("a"); a.href = url; a.download = `prompts_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); 
        Toast.show("Backup scaricato!", 'success'); 
    }

    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const data = JSON.parse(e.target.result); 
                if (!Array.isArray(data)) throw new Error("Formato non valido");
                await updateStateAndSave(data, { saveHistory: false });
                Toast.show("Importazione riuscita!", 'success');
            } catch (err) { 
                Toast.show("Errore durante l'importazione", 'error'); 
            }
        };
        reader.readAsText(file); event.target.value = '';
    }
    
    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('themeToggle').addEventListener('click', () => { 
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light'; 
            document.documentElement.setAttribute('data-theme', newTheme); 
            localStorage.setItem('theme', newTheme); 
            document.getElementById('themeToggle').innerHTML = newTheme === 'dark' ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
        });
        
        categoryDropdown.addEventListener('change', () => {
            const selection = categoryDropdown.value;
            if (['favorites', 'recents', 'tags', 'search'].includes(selection)) {
                state.currentView = selection;
                state.activePromptId = null; 
            } else {
                state.currentView = 'columns';
                state.activeCategoryId = selection;
                const newCat = state.allData.find(c => c.id === selection);
                const firstSub = newCat?.subcategories[0];
                state.activeSubcategoryId = firstSub?.id || null;
                state.activePromptId = firstSub?.prompts[0]?.id || null;
            }
            renderUI();
        });
        
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.trim().length > 0) {
                state.currentView = 'search';
                renderUI();
            } else {
                state.currentView = 'columns';
                renderUI();
            }
        });
        
        imageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) insertBase64Image(e.target.files[0]);
            e.target.value = ''; 
        });

        const toolBtn = document.getElementById('toolBtn');
        const toolMenu = document.getElementById('toolMenu');
        toolBtn.addEventListener('click', e => { e.stopPropagation(); toolMenu.classList.toggle('show'); });
        window.addEventListener('click', () => toolMenu.classList.remove('show'));
        document.getElementById('btnAddCategory').onclick = addCategory;
        document.getElementById('btnAnnulla').onclick = performUndo;
        document.getElementById('btnRipristina').onclick = performRedo;
        document.getElementById('btnBackup').onclick = backupData;
        document.getElementById('btnImporta').onclick = () => document.getElementById('backupInput').click();
        document.getElementById('backupInput').onchange = importData;

        linkModalCancel.onclick = hideLinkModal;
        linkModalConfirm.onclick = () => applyLink(linkUrlInput.value.trim());
        renameModalCancel.onclick = hideRenameModal;
        renameModalConfirm.onclick = handleRenameConfirm;
    }

    // --- INITIALIZATION ---
    async function initialize() {
        try {
            Loader.show();
            await Database.init();
            state.allData = await Database.load();
            state.recents = JSON.parse(localStorage.getItem('promptManagerRecents')) || [];

            if (state.allData.length === 0) {
                state.allData = [{ id: 'cat_1', name: 'AI Generative', subcategories: [{ id: 'sub_1', name: 'Esempio', prompts: [{id: 'p_1', title: 'Benvenuto', description: 'Benvenuto! Prova le nuove variabili.<br><br>Scrivi un post su {{Argomento}} con tono {{Tono:Formale|Amichevole|Divertente}}.<br>La lingua di output Ã¨ {{Lingua:Italiano}}.', favorite: true, tags: ['info']}] }] }];
                await Database.save(state.allData);
            }
            
            setupEventListeners();
            renderUI();
        } catch (error) {
            console.error(error);
            Toast.show("Errore di inizializzazione", 'error');
        } finally {
            Loader.hide();
        }
    }
    initialize();
})();
</script>
</body>
</html>
